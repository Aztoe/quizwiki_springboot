<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/pboard_layout}" layout:fragment="content">
<head>
<meta charset="UTF-8">
<title>Quiz Wiki</title>

<!-- CSS -->
<link rel="stylesheet" type="text/css"
	href="/css/pboard/pboard_write.css" />
<link rel="stylesheet" type="text/css"
	href="/css/pboard/pboard_add_popup.css" />
<!-- js -->
<script src="/libs/se2/js/service/HuskyEZCreator.js"></script>

</head>
<body>
	<!-- pboard_write -->
	<div id="pboard-write">
		<div class="pboard-write-outer">
			<div id="pboard-title">
				<span class="title-desc">문제게시판 글쓰기 <span
					class="title-subject">국어 (쓰기)</span></span>

			</div>

			<form id="editor-form" name="editor-form" action="POST">
				<div>
					<input id="pboard-title-input" placeholder="글 제목을 입력해주세요."
						name="title" type="text" />
				</div>
				<textarea name="se2" id="se2" rows="10" cols="100"></textarea>

				<div class="hr-shifter"></div>

				<div id="pmaker-area">
					<div class="pmaker-desc-container">
						<h1>문제만들기</h1>
						<h6>객관식(2개~5개선택지),주관식(정답 30자제한) 게시물당 최대 40개의 문항을 만들 수 있습니다.</h6>

						<div id="plist-add-btn" class="ui-btn">문제 추가</div>
					</div>

					<table class="plist-item-table">
						<thead>
							<tr draggable="false">
								<th class="plist-item-no plist-right-border">번호</th>
								<th class="plist-item-no plist-right-border">종류</th>
								<th class="plist-item-content plist-right-border">내용</th>
								<th class="plist-item-no"></th>
							</tr>
						</thead>

						<tbody id="plist-body">
							<tr class="putable" draggable="true">
								<td class="plist-item-no plist-right-border">1</td>
								<td class="plist-item-no plist-right-border">객관식</td>
								<td class="plist-item-content plist-right-border">다음중 옳바른
									것을 고르시오.</td>
								<td class="plist-item-no"><i
									class="fa-solid fa-pen-to-square"></i> <i
									class="fa-sharp fa-solid fa-trash"></i></td>
							</tr>

							<tr class="putable" draggable="true">
								<td class="plist-item-no plist-right-border">2</td>
								<td class="plist-item-no plist-right-border">주관식</td>
								<td class="plist-item-content plist-right-border">다음에 해당하는
									것을 적으시오.</td>
								<td class="plist-item-no"><i
									class="fa-solid fa-pen-to-square"></i> <i
									class="fa-sharp fa-solid fa-trash"></i></td>
							</tr>

							<tr class="putable" draggable="true">
								<td class="plist-item-no plist-right-border">3</td>
								<td class="plist-item-no plist-right-border">주관식</td>
								<td class="plist-item-content plist-right-border">다음에 해당하는
									것을 적으시오.</td>
								<td class="plist-item-no"><i
									class="fa-solid fa-pen-to-square"></i> <i
									class="fa-sharp fa-solid fa-trash"></i></td>
							</tr>
						</tbody>
					</table>
				</div>

				<div class="hr-shifter"></div>

				<div class="btn-list">
					<div id="write-btn" class="ui-btn">게시하기</div>
				</div>
			</form>
		</div>

	</div>



<!--====================== modal popup ================ -->
	<div id="add_popup">
		<div id="add_popup_bg"></div>
		<form id="add_popup_form">
			<div class="add_popup_title">
				<h1>
					<i class="fa-solid fa-pen-to-square"></i>문제만들기
				</h1>
				<div class="add_popup_cbox">
					<fieldset>
						<legend>문제 유형</legend>
						<div class="cbox-item">
							<input id="stype-ratio" type="radio" name="type" value="s" /> <label
								for="stype-ratio"> <span class="round">라디오버튼</span> <i
								class="far fa-comment-dots"></i> 주관식
							</label>
						</div>

						<div class="cbox-item">
							<input id="mtype-ratio" type="radio" name="type" value="m"
								checked /> <label for="mtype-ratio"> <span class="round">라디오버튼</span>
								<i class="fa-solid fa-list"></i> 객관식
							</label>
						</div>
					</fieldset>
				</div>
			</div>

			<div class="hr-shifter"></div>

			<div style="min-height: 500px;" class="add_popup_content">

				<div class="add_popup_maker">
					<div class="pmaker_item">
						<h4>문제 내용:</h4>
						<input name="content" class="custom-input" type="text" />
					</div>

					<div class="pmaker_item">
						<h4>지문:</h4>
						<textarea name="print" rows="3" class="custom-input"></textarea>
					</div>

					<div class="pmaker_item">
						<h4>지문 첨부파일:</h4>
						<input name="printfile" class="custom-input" type="file" />
					</div>

					<div class="mp-items">
						<div class="pmaker_item">
							<h4>선택지:</h4>
							<ul id="pmaker_answer_list">
								<li><input name="choise" class="custom-input" type="text" onkeyup="syncChoise(this)"/></li>
								<li><input name="choise" class="custom-input" type="text" onkeyup="syncChoise(this)"/></li>
							</ul>
						</div>
						<div class="add-popup-btn blue-btn" onclick="makeChoise()">선택지 추가</div>
					</div>
					
					<div class="pmaker_item">
						<h4>정답:</h4>
						<input name="spanswer" class="custom-input sp-items" type="text" />
						<div id="mp-answer" class="pmaker_answer_cbox mp-items">
							<fieldset id="answer-field">
								<legend>정답</legend>
								<div class="answer-item">
									<input id="answer-ratio" type="radio" name="answer" value="1"/>
									<label for="answer-ratio"><span class="answer-ratio-text">1</span><span class="round"></span></label>
								</div>
								
								<div class="answer-item">
									<input id="answer-ratio2" type="radio" name="answer" value="2" />
									<label for="answer-ratio2"><span class="answer-ratio-text">2</span><span class="round"></span></label>
								</div>
							</fieldset>
						</div>
					</div>

					<div class="pmaker_item">
						<h4>해설:</h4>
						<textarea name="desc" rows="3" class="custom-input"></textarea>
					</div>

				</div>

				<div class="add_popup_preview">
					<h2>
						<i class="fa-solid fa-magnifying-glass"></i>미리보기
					</h2>
					<div class="problem_preview">

						<p id="precontent" class="problem_content"></p>

						<div class="problem_print">
							<pre id="preprint">
                            </pre>
						</div>

						<ul id="pre-answer-list" class="problem_answer_list mp-items">
							<li></li>
							<li></li>
						</ul>
					</div>
				</div>
			</div>

			<div class="add_popup_btnlist">
				<div id="problem-regbtn" class="add-popup-btn blue-btn">등록</div>
				<div id="add-popup-close" class="add-popup-btn red-btn">닫기</div>
			</div>

		</form>
	</div>
	<!-- pboard_write end -->


	<!-- se2 -->
	<script>
    var oEditors = [];
	nhn.husky.EZCreator.createInIFrame({
		oAppRef : oEditors,
		elPlaceHolder : "se2",
		sSkinURI : "/libs/se2/SmartEditor2Skin.html",
		fCreator : "createSEditor2",
		htParams : {
			// 툴바 사용 여부 (true:사용/ false:사용하지 않음)
			bUseToolbar : true,

			// 입력창 크기 조절바 사용 여부 (true:사용/ false:사용하지 않음)
			bUseVerticalResizer : false,

			// 모드 탭(Editor | HTML | TEXT) 사용 여부 (true:사용/ false:사용하지 않음)
			bUseModeChanger : false
		}
	});
	</script>
	<!-- se2 end -->

	<script type="text/javascript">
	/*
		todolist:
			문제팝업에서 등록이후 문제리스트와 동기화처리
			
			문제 지문이미지 처리
			
			문제 편집  처리
			
			문제 삭제 처리
			
			문제 순서 변경시 객체와 동기화처리
			
			게시하기 ajax로 데이터 정리해서 서버에 보낸뒤
			서버에서는 pboard 와 problem DB에 각각 저장하는데 트랜젝션처리
			
	*/ 

	
	
	
	
	/*==============initialized=================*/
	/* popup addform 안의 input요소 빼기 쉽게 최상위태그 form 변수에 담아둠*/
	let addform = document.getElementById("add_popup_form");
	
	/* plist 현재 작성중인 게시글에서 문제list 변수에 담아둠*/
	let problemList = [
		
	];
	
	/* 문제추가 폼에서 보여지는 문제 객체 선언 */
	let currentProblem = {};
	
	/* 동기화할때 접근하기 쉽게 변수에 담아둠 */
	let answerList = document.getElementById("pmaker_answer_list");
	let answerField = document.getElementById("answer-field");
	
	/* preview */
	let preContent = document.getElementById("precontent");
	let prePrint = document.getElementById("preprint");
	let preAnswerList = document.getElementById("pre-answer-list");
	
	/* ======================================*/
	
	
	
	
	
	
	
	
	/*================== UI ITEMS EventHandler===================== */
	/* 문제팝업 등록 버튼 */
	$("#problem-regbtn").on("click", ()=>{
		//init
		let choise = null;
		let answer = "";
		
		//type에 따라 분기처리
		if(addform.type.value=="m"){
			let choiseCount = answerList.childElementCount;
			
			choise = [];
			for(let i=0; i<choiseCount; i++){
				let choiseText = addform.choise[i].value;
				choise.push(choiseText);
			}
			
			answer = addform.answer.value;
		}else{
			answer = addform.spanswer.value;
		}
		
		//문제객체 문제리스트에 push
		makeProblem(
			addform.type.value,
			addform.content.value,
			addform.print.value,
			addform.printfile.value,
			choise,
			answer,
			addform.desc.value
		);
	});
	
	/* plist-add-btn (문제 추가 버튼)*/
	
	let plistAddBtn = document.getElementById("plist-add-btn");
	let plistAddPopup = document.getElementById("add_popup");
	plistAddBtn.addEventListener("click", ()=>{
		currentProblem = {};
		resetForm();
		document.body.style.overflow = "hidden";
		plistAddPopup.style.display = "block";
		typeCheck();
	});
	/* plist-add-btn end. */
	
	/* add-popup-close (문제 추가 팝업 닫기 버튼)*/
	let addPopupCloseBtn = document.getElementById("add-popup-close");
	addPopupCloseBtn.addEventListener("click", ()=>{
		document.body.style.overflow = "auto";
		plistAddPopup.style.display = "none";
	});
	
	
	/*plist Drag And Drop (문제리스트 드래그드롭 관련)*/
	let plist = document.querySelector("#plist-body");
	
	let picked = null;
	let pickedIndex = null;
	
	plist.addEventListener("dragstart",(e)=>{
		let obj = e.target;
		
		picked = e.target;
		pickedIndex = [...obj.parentNode.children].indexOf(obj);
		picked.classList.add("picked-item");
	});
	
	plist.addEventListener("dragover",(e)=>{
		e.preventDefault();
	});
	
	plist.addEventListener("drop",(e)=>{
		picked.classList.remove("picked-item");
		if(picked.getAttribute("draggable") != "true") return;
		
		let el = e.target.parentNode;
		if(el.tagName != "TR" || !el.classList.contains("putable")) return;
		
		let index = [...(el.parentNode.children)].indexOf(el);
		
		(index > pickedIndex) ? el.after(picked) : el.before(picked)
	});
	/* plist Drag And Drop end. */
	
	/* ptype radio (문제 종류 라디오 버튼 )*/
	addform.addEventListener('change', function(){
		typeCheck();
	});
	/* ptype radio end*/
	
	/* pcontent input keyup (문제 내용 인풋)*/
	$(addform.content).on("keyup", function(){
		preContent.textContent = this.value;
	});
	/* pcontent input keyup end */
	
	/* pprint input keyup (지문 인풋)*/
	$(addform.print).on("keyup", function(){
		prePrint.textContent = this.value;
	});
	/* pcontent input keyup end */
	/* =================================================== */
	
	
	/*================== FUNCTIONS   ===================== */
	//add form 리셋
	function resetForm(){
        //type reset 문제타입 주관식으로 기본값설정
        addform.type.value = "s";

        //content reset 문제 내용 초기화
        addform.content.value = "";
        
        //print reset 지문 초기화
        addform.print.value="";
        
        //answerList reset 문항리스트 초기화
        $(answerList).children().slice(2,5).remove();
        $("input[name='choise']").val("");
        
        //printfile reset 지문파일 초기화
        $("input[name='printfile']").val(null);
        
        
      	//answer radio reset 정답라디오박스 초기화
        addform.spanswer.value = "";
        
      	//answer radio reset 정답라디오박스 초기화
        addform.answer.value = null;
        /* slice 레전드를 고려해서 매개변수 +1씩 */
        $(answerField).children().slice(3,6).remove();

        //desc reset 
        addform.desc.value = "";
        
        /* preview Reset */
        preContent.textContent = "";
        prePrint.textContent = "";
        $(preAnswerList).children().slice(0,3).text("");
        $(preAnswerList).children().slice(2,5).remove();
    }
	
	//  currentproblem -> addform 싱크맞추기
	function syncCurrentProblem(){
		
	}
	
	
	
	// 객관식문제 선택지 만들기
	function makeChoise(){
		if(answerList.childElementCount >= 5){
			alert("선택지는 최대 5개까지 추가할 수 있습니다.");
			return;
		}
		
		
	    let li = document.createElement("li");
	    
	    let answerWrap = document.createElement("div");
	    answerWrap.classList.add("answer-wrap");

	    let customInput = document.createElement("input");
	    customInput.setAttribute("type","text");
	    customInput.setAttribute("name","choise");
	    customInput.classList.add("custom-input");
	    
	    
	    let deleteBtn = document.createElement("div");
	    deleteBtn.classList.add("answer-delete-btn");
	    

	    let deleteIcon = document.createElement("i");
	    deleteIcon.classList.add("fa-solid");
	    deleteIcon.classList.add("fa-delete-left");

	    deleteBtn.appendChild(deleteIcon);
	    answerWrap.appendChild(customInput);
	    answerWrap.appendChild(deleteBtn);
	    
	    li.appendChild(answerWrap);
	    
	    answerList.appendChild(li);
	    
	    customInput.addEventListener("keyup",function(){syncChoise(this)});
	    deleteBtn.addEventListener("click",()=>{deleteChoise(deleteBtn)});
	    
	    /* 정답 선택 라디오박스 만들기 */
	    makeAnswerRadio();
	    
	    /* 프리뷰 li만들기 */
	    let preli = document.createElement("li");
	    preAnswerList.appendChild(preli);
	    
	}
	
	//문제 선택지 정답 라디오 버튼 만들기(?)
	function makeAnswerRadio(){
	    let answerInputList = document.querySelectorAll('input[name="answer"]');
	    let inputVal = answerInputList.length+1;

	    let answerItem = document.createElement("div");
	    answerItem.classList.add("answer-item");

	    let answerInput = document.createElement("input");
	    answerInput.setAttribute("type","radio");
	    answerInput.setAttribute("name","answer");
	    answerInput.setAttribute("value",inputVal);
	    answerInput.id = "answer-ratio"+inputVal;

	    let label = document.createElement("label");
	    label.setAttribute("for","answer-ratio"+inputVal);
	    
	    let labelSpan = document.createElement("span");
	    labelSpan.classList.add("answer-ratio-text");
	    
	    labelSpan.textContent = inputVal;
	    let span = document.createElement("span");
	    span.classList.add("round");

	    label.appendChild(labelSpan);
	    label.appendChild(span);

	    answerItem.appendChild(answerInput);
	    answerItem.appendChild(label);
		
	    answerField.appendChild(answerItem);
	}
	
	// 객관식문제 선택지 지우기
	function deleteChoise(el){
		let parentLi = el.parentElement.parentElement;
		let count = 0;
		while(parentLi.tagName != "LI"){
			parentLi = el.parentElement;
			count++;
			if(count > 10) return;
		}
		let index = $(parentLi).index()+1;
		$(parentLi).remove();
		
		
		/* 정답 선택지 지우기 */
		for(let i = index+1; i<=5; i++){
			let tg = $(`input[name='answer'][value=${i}]`);
			tg.val(i-1);
			tg.attr('id','answer-ratio'+(i-1));
			
			let labelfor = "answer-ratio"+i;
			
			let label = $(`label[for=${labelfor}]`);
			label.attr('for', 'answer-ratio'+(i-1));
			label.find('.answer-ratio-text').text(i-1);

		}
		
		/* 프리뷰 li 지우기 */
		$(preAnswerList).children().eq(index-1).remove();
				
		// 인풋박스 지우기
		$("#answer-ratio"+index).parent().remove();
	}
	
	
	// 객관식문제 내용 preview 동기화
	// 동적으로 생성되는 요소에 이벤트리스너를 달아줘야하므로 펑션으로 정의해둠.
	function syncChoise(el){
		let parentLi = el.parentElement.parentElement;
		let count = 0;
		
		while(parentLi.tagName != "LI"){
			parentLi = el.parentElement;
			count++;
			if(count > 10) return;
		}
		
		let index = $(parentLi).index();
		preAnswerList.children[index].textContent = el.value;
	}
	
	// 문제 객체 만들어서 문제리스트에 push
	function makeProblem(type,content,print,printfile,choise,answer,desc){
		let p = {};
		p.type=type;
		p.content=content;
		p.print = print;
		p.printfile = printfile;
		p.choise = choise;
		p.answer = answer;
		p.desc = desc;
		
		console.log(p);
		problemList.push(p);
	}
	
	// 문제 타입체크해서 html 조정
	function typeCheck(){
		if(addform.type.value=="m"){
			$(".mp-items").css('display','block');
			$(".sp-items").css('display','none');
		}else{
			$(".mp-items").css('display','none');
			$(".sp-items").css('display','block');
		}
	}
	/* =================================================== */
	</script>
</body>
</html>